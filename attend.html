<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body class="bg-light">

  <div class="container mt-4">
    <h2 class="text-center mb-4">üìã Attendance Management</h2>

    <!-- Mark Attendance Form -->
    <div class="card shadow p-3 mb-4">
      <h5>Mark Attendance</h5>
      <form id="attendanceForm">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Select Student</label>
            <select id="studentSelect" class="form-control" required>
              <option value="">-- Select Student --</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Email</label>
            <input type="text" id="studentEmail" class="form-control" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label">Reg Number</label>
            <input type="text" id="regNumber" class="form-control" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label">Course</label>
            <input type="text" id="course" class="form-control" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label">Date</label>
            <input type="date" id="date" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Status</label>
            <select id="status" class="form-control" required>
              <option value="Present">‚úÖ Present</option>
              <option value="Absent">‚ùå Absent</option>
              <option value="Late">‚è∞ Late</option>
            </select>
          </div>
        </div>
        <button type="submit" class="btn btn-success mt-3">Save Attendance</button>
      </form>
    </div>

    <!-- Attendance Records -->
    <div class="card shadow p-3">
      <h5>Attendance Records</h5>
      <table class="table table-bordered mt-3">
        <thead class="table-dark">
          <tr>
            <th>Student</th>
            <th>Email</th>
            <th>Reg Number</th>
            <th>Course</th>
            <th>Date</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="attendanceTable"></tbody>
      </table>
    </div>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBdabXqlBQ-6yVNJKdu8Zhb9Cm_-59_u24",
      authDomain: "bett-294a2.firebaseapp.com",
      projectId: "bett-294a2",
      storageBucket: "bett-294a2.appspot.com",
      messagingSenderId: "1055511650032",
      appId: "1:1055511650032:web:7e0f9c28e58515f549ac35"
    };

    // Init Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const studentSelect = document.getElementById("studentSelect");
    const studentEmail = document.getElementById("studentEmail");
    const regNumber = document.getElementById("regNumber");
    const course = document.getElementById("course");
    const attendanceForm = document.getElementById("attendanceForm");
    const attendanceTable = document.getElementById("attendanceTable");

    let studentMap = {};

    // Load Students
    async function loadStudents() {
      const snapshot = await db.collection("students").get();
      studentSelect.innerHTML = '<option value="">-- Select Student --</option>';
      snapshot.forEach(doc => {
        const s = doc.data();
        studentMap[doc.id] = s;
        studentSelect.innerHTML += `<option value="${doc.id}">${s.name}</option>`;
      });
    }

    // Auto-fill student info when selected
    studentSelect.addEventListener("change", () => {
      const selectedId = studentSelect.value;
      if (selectedId && studentMap[selectedId]) {
        const s = studentMap[selectedId];
        studentEmail.value = s.email || "";
        regNumber.value = s.regNumber || "";
        course.value = s.course || "";
      } else {
        studentEmail.value = "";
        regNumber.value = "";
        course.value = "";
      }
    });

    // Save Attendance
    attendanceForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const studentId = studentSelect.value;
      const s = studentMap[studentId];
      const date = document.getElementById("date").value;
      const status = document.getElementById("status").value;

      if (!studentId) return alert("Please select a student!");

      await db.collection("attendance").add({
        studentId,
        studentName: s.name,
        email: s.email || "",
        regNumber: s.regNumber || "",
        course: s.course || "",
        date,
        status
      });

      alert("Attendance saved ‚úÖ");
      attendanceForm.reset();
      loadAttendance();
    });

    // Load Attendance Records
    async function loadAttendance() {
      attendanceTable.innerHTML = "";
      const snapshot = await db.collection("attendance").get();
      snapshot.forEach(doc => {
        const a = doc.data();
        attendanceTable.innerHTML += `
          <tr>
            <td>${a.studentName}</td>
            <td>${a.email}</td>
            <td>${a.regNumber}</td>
            <td>${a.course}</td>
            <td>${a.date}</td>
            <td>${a.status}</td>
            <td><button class="btn btn-danger btn-sm" onclick="deleteAttendance('${doc.id}')">Delete</button></td>
          </tr>`;
      });
    }

    // Delete Attendance
    async function deleteAttendance(id) {
      if (confirm("Delete this record?")) {
        await db.collection("attendance").doc(id).delete();
        loadAttendance();
      }
    }
    window.deleteAttendance = deleteAttendance;

    // Init
    loadStudents();
    loadAttendance();
  </script>
</body>
</html>