<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fee Management</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">
  <div class="container mt-4">
    <h2 class="text-center mb-4">ðŸ’° Fee Management</h2>

    <!-- Add Fee Form -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">Add Fee Record</div>
      <div class="card-body">
        <form id="feeForm">
          <div class="mb-3">
            <label class="form-label">Select Student</label>
            <select id="studentSelect" class="form-control" required></select>
          </div>
          <div class="mb-3">
            <label class="form-label">Fee Type</label>
            <input type="text" id="feeType" class="form-control" placeholder="e.g. Tuition, Library" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Amount</label>
            <input type="number" id="feeAmount" class="form-control" placeholder="Enter amount" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Due Date</label>
            <input type="date" id="feeDueDate" class="form-control" required>
          </div>
          <button type="submit" class="btn btn-success">Add Fee</button>
        </form>
      </div>
    </div>

    <!-- Fee Records Table -->
    <div class="card">
      <div class="card-header bg-info text-white">All Fee Records</div>
      <div class="card-body">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>Student</th>
              <th>Fee Type</th>
              <th>Amount</th>
              <th>Due Date</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="feeTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { 
      getFirestore, collection, getDocs, addDoc, updateDoc, doc 
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBdabXqlBQ-6yVNJKdu8Zhb9Cm_-59_u24",
      authDomain: "bett-294a2.firebaseapp.com",
      projectId: "bett-294a2",
      storageBucket: "bett-294a2.appspot.com",
      messagingSenderId: "1055511650032",
      appId: "1:1055511650032:web:7e0f9c28e58515f549ac35"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const studentSelect = document.getElementById("studentSelect");
    const feeTable = document.getElementById("feeTable");

    // Load Students
    async function loadStudents() {
      const snap = await getDocs(collection(db, "students"));
      studentSelect.innerHTML = "";
      snap.forEach(d => {
        const data = d.data();
        studentSelect.innerHTML += `<option value="${d.id}">${data.name} (${data.regNumber || "No Reg"})</option>`;
      });
    }

    // Load Fees
    async function loadFees() {
      const snap = await getDocs(collection(db, "fees"));
      feeTable.innerHTML = "";
      snap.forEach(d => {
        const data = d.data();
        feeTable.innerHTML += `
          <tr>
            <td>${data.studentName}</td>
            <td>${data.feeType}</td>
            <td>${data.amount}</td>
            <td>${data.dueDate}</td>
            <td>${data.status}</td>
            <td>
              ${data.status === "Unpaid" ? 
                `<button class="btn btn-sm btn-success" onclick="markPaid('${d.id}')">Mark Paid</button>` 
                : "âœ” Paid"}
            </td>
          </tr>`;
      });
    }

    // Add Fee Record
    document.getElementById("feeForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const studentId = studentSelect.value;
      const studentName = studentSelect.options[studentSelect.selectedIndex].text;
      const feeType = document.getElementById("feeType").value;
      const amount = document.getElementById("feeAmount").value;
      const dueDate = document.getElementById("feeDueDate").value;

      await addDoc(collection(db, "fees"), {
        studentId, studentName, feeType, amount, dueDate,
        status: "Unpaid"
      });

      loadFees();
    });

    // Mark Fee as Paid
    window.markPaid = async function (id) {
      await updateDoc(doc(db, "fees", id), { status: "Paid" });
      loadFees();
    }

    // Load everything
    loadStudents();
    loadFees();
  </script>
</body>
</html>